<project name="de.pellepelster.myadmin.demo.server.test" xmlns:ivy="antlib:org.apache.ivy.ant">

	<property name="test.suite.name" value="trigger text execution" />

	<import file="../de.pellepelster.myadmin.demo.build/ant/demo.xml" />

	<property file="build.properties" />

	<property name="jetty.temp.location" value="${basedir}/jetty-temp" />
	<property name="db.temp.location" value="${basedir}/db-temp" />
	<property name="jetty.lib.dir" value="${basedir}/jetty-lib" />

	<macrodef name="openInBrowser">
		<attribute name="url" />
		<sequential>
			<exec dir="${basedir}" os="Windows 7" executable="rundll32.exe">
				<arg line="url.dll, FileProtocolHandler" />
				<arg line="@{url}" />
			</exec>
			<exec dir="${basedir}" os="Linux" executable="xdg-open">
				<arg line="@{url}" />
			</exec>
		</sequential>
	</macrodef>


	<macrodef name="tomcat.local">
		
		<attribute name="action" />
		
		<sequential>
			<taskdef resource="cargo.tasks">
				<classpath>
					<pathelement location="lib/cargo-core-uberjar-jar.jar" />
					<pathelement location="lib/cargo-ant-jar.jar" />
					<fileset dir="lib" includes="*jar" />
				</classpath>
			</taskdef>

			<mkdir dir="tomcat" />
			<mkdir dir="tomcat/downloads" />
			<mkdir dir="tomcat/extracts" />
			<mkdir dir="tomcat/logs" />

			<cargo containerId="tomcat6x" output="tomcat/logs/output.log" log="tomcat/logs/cargo.log" action="@{action}">

				<zipUrlInstaller installUrl="http://www.apache.org/dist/tomcat/tomcat-6/v6.0.36/bin/apache-tomcat-6.0.36.zip" downloadDir="tomcat/downloads" extractDir="tomcat/server" />

				<extraClasspath>
					<pathelement location="lib/derby-jar.jar" />
				</extraClasspath>

				<configuration>
		         	<!-- <property name="cargo.logging" value="high"/> -->
					<property name="cargo.servlet.port" value="${remote.port}" />
					
					<!-- <property name="cargo.jvmargs" value="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=9999 -Xnoagent -Djava.compiler=NONE" /> -->
					<property name="cargo.datasource.datasource1" value="cargo.datasource.driver=org.apache.derby.jdbc.EmbeddedDriver|cargo.datasource.url=jdbc:derby:derbyDB;create=true|cargo.datasource.jndi=jdbc/Demo|cargo.datasource.username=demo|cargo.datasource.password=nonemptypassword" />
					<deployable type="war" file="../de.pellepelster.myadmin.demo.server/${build.dir}/de.pellepelster.myadmin.demo.war" />
				</configuration>

			</cargo>
		</sequential>
	</macrodef>

	<target name="tomcat.local.run" depends="resolve">
		<tomcat.local action="run" />
	</target>

	<target name="tomcat.local.start" depends="resolve">
		<tomcat.local action="start" />
	</target>

	<target name="import.dictionary" depends="resolve">

		<taskdef name="dictionaryimporter" classpathref="lib.path.id" classname="de.pellepelster.myadmin.tools.dictionary.DictionaryImporter" />
		<dictionaryimporter classpathref="lib.path.id" modelfile="classpath:Demo.msl" remotepath="${remote.path}" remoteport="${remote.port}" remoteuser="${remote.username}" remotepassword="${remote.password}" remoteserver="${remote.server}" />

	</target>

	<target name="test" depends="test.selenium.local">
	</target>

	<target name="test.selenium.local" depends="tomcat.local.start, import.dictionary">

		<mkdir dir="${test.dir}"/>
		
		<junit printsummary="yes" newenvironment="yes" haltonfailure="yes" fork="true">

			<classpath refid="lib.path.id" />
			
			<classpath>
				<fileset dir="${build.dir}" includes="*.jar" excludes="*-source.jar" />
			</classpath>

			<sysproperty key="screenshot.dir" value="${test.dir}"/>
			<sysproperty key="selenium.base.url" value="${remote.url}"/>

			<formatter type="xml" />

			<test name="de.pellepelster.myadmin.demo.server.SeleniumTests" haltonfailure="yes" outfile="${test.dir}/de.pellepelster.myadmin.demo.server.SeleniumTests" />

		</junit>

	</target>
	

	<target name="start.client">
		<openInBrowser url="http://${remote.server}:${remote.port}/de.pellepelster.myadmin.demo/Demo/Demo.html"/>
	</target>

</project>
